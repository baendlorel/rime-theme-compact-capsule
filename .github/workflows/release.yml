name: Build and Publish Release

on:
  push:
    branches:
      - release

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Read version from package.json
        id: version
        run: |
          VERSION="$(node -p 'require("./package.json").version')"
          echo "value=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create git tag from package version
        run: |
          TAG="${{ steps.version.outputs.value }}"
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists, skip creating."
            exit 0
          fi
          git tag "${TAG}"
          git push origin "${TAG}"

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.version.outputs.value }}
        run: |
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists, uploading latest artifacts."
            gh release upload "${TAG}" dist/* --clobber
            exit 0
          fi

          gh release create "${TAG}" dist/* \
            --title "${TAG}" \
            --generate-notes \
            --target "${GITHUB_SHA}"

      - name: Prepare GitHub Pages artifact
        run: |
          mkdir -p _site
          cp assets/demo.html _site/index.html

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy-pages:
    needs: build-and-release
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
